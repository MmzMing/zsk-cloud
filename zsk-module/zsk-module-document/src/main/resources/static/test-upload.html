<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分块上传测试 - ZSK-Cloud</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            padding: 40px;
            background-color: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }

        h2 {
            margin-top: 0;
            color: #409EFF;
            border-bottom: 2px solid #ebeef5;
            padding-bottom: 10px;
        }

        .form-item {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        input[type="file"] {
            display: block;
            width: 100%;
            padding: 10px;
            border: 1px dashed #dcdfe6;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn {
            background-color: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .btn:disabled {
            background-color: #a0cfff;
            cursor: not-allowed;
        }

        .btn:hover:not(:disabled) {
            background-color: #66b1ff;
        }

        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }

        .info {
            background-color: #f4f4f5;
            color: #909399;
        }

        .success {
            background-color: #f0f9eb;
            color: #67c23a;
        }

        .error {
            background-color: #fef0f0;
            color: #f56c6c;
        }

        .progress-container {
            margin-top: 20px;
            height: 20px;
            background-color: #ebeef5;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }

        #progress-bar {
            height: 100%;
            background-color: #67c23a;
            width: 0%;
            transition: width 0.3s;
        }

        #log {
            margin-top: 20px;
            padding: 10px;
            background: #303133;
            color: #fff;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
            border-radius: 4px;
            font-size: 12px;
        }

        .log-item {
            margin-bottom: 4px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>文件分块上传测试</h2>

    <div class="form-item">
        <label>接口基本路径 (Base URL)</label>
        <input type="text" id="baseUrlInput" value="http://127.0.0.1:20020/document"
               placeholder="例如: http://127.0.0.1:20020/document"
               style="width: 100%; padding: 10px; border: 1px solid #dcdfe6; border-radius: 4px; box-sizing: border-box;">
    </div>

    <div class="form-item">
        <label for="fileInput">选择文件 (建议选择大文件测试)</label>
        <input type="file" id="fileInput">
    </div>

    <div class="form-item">
        <button id="uploadBtn" class="btn">开始上传</button>
    </div>

    <div class="progress-container" id="progressContainer">
        <div id="progress-bar"></div>
    </div>

    <div id="status"></div>

    <div id="log">
        <div class="log-item">等待操作...</div>
    </div>
</div>

<script>
    const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const statusDiv = document.getElementById('status');
    const logDiv = document.getElementById('log');
    const progressBar = document.getElementById('progress-bar');
    const progressContainer = document.getElementById('progressContainer');

    // 自动获取上下文路径 (context-path)
    // 如果页面地址是 http://127.0.0.1:20020/document/test-upload.html
    // 那么 window.location.pathname 是 /document/test-upload.html
    // 我们需要的是 /document
    const getContextPath = () => {
        const path = window.location.pathname; // 示例: "/document/test-upload.html"
        const index = path.lastIndexOf('/');
        return path.substring(0, index); // 示例: "/document"
    };
    const baseUrlInput = document.getElementById('baseUrlInput');

    // 初始化 BASE_URL
    let BASE_URL = baseUrlInput.value || getContextPath();

    // 监听输入框变化更新 BASE_URL
    baseUrlInput.addEventListener('input', (e) => {
        BASE_URL = e.target.value;
    });

    function log(msg) {
        const item = document.createElement('div');
        item.className = 'log-item';
        item.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logDiv.appendChild(item);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function showStatus(msg, type) {
        statusDiv.innerText = msg;
        statusDiv.className = type;
        statusDiv.style.display = 'block';
    }

    // 计算文件MD5
    function calculateMD5(file) {
        return new Promise((resolve, reject) => {
            const spark = new SparkMD5.ArrayBuffer();
            const reader = new FileReader();
            const chunks = Math.ceil(file.size / CHUNK_SIZE);
            let currentChunk = 0;

            log(`开始计算文件MD5, 总分片数: ${chunks}`);

            reader.onload = function (e) {
                spark.append(e.target.result);
                currentChunk++;

                if (currentChunk < chunks) {
                    loadNext();
                } else {
                    const md5 = spark.end();
                    log(`MD5计算完成: ${md5}`);
                    resolve(md5);
                }
            };

            reader.onerror = reject;

            function loadNext() {
                const start = currentChunk * CHUNK_SIZE;
                const end = ((start + CHUNK_SIZE) >= file.size) ? file.size : start + CHUNK_SIZE;
                reader.readAsArrayBuffer(file.slice(start, end));
            }

            loadNext();
        });
    }

    uploadBtn.onclick = async () => {
        const file = fileInput.files[0];
        if (!file) {
            alert('请先选择文件');
            return;
        }

        uploadBtn.disabled = true;
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        showStatus('正在处理...', 'info');

        try {
            // 1. 计算MD5
            const md5 = await calculateMD5(file);

            // 2. 初始化分片上传
            log(`正在初始化分片上传, 请求地址: ${BASE_URL}/files/multipart/init`);
            const initRes = await fetch(`${BASE_URL}/files/multipart/init`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    fileName: file.name,
                    contentType: file.type || 'application/octet-stream',
                    md5: md5
                })
            }).then(async res => {
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`HTTP ${res.status}: ${text.substring(0, 100)}`);
                }
                return res.json();
            });

            if (initRes.code !== 200) throw new Error(initRes.msg || '初始化失败');
            const uploadId = initRes.data;
            log(`初始化成功, uploadId: ${uploadId}`);

            // 3. 上传分片
            const chunks = Math.ceil(file.size / CHUNK_SIZE);
            const parts = [];

            for (let i = 0; i < chunks; i++) {
                const partNumber = i + 1;
                const start = i * CHUNK_SIZE;
                const end = Math.min(file.size, start + CHUNK_SIZE);
                const chunk = file.slice(start, end);

                log(`正在上传第 ${partNumber}/${chunks} 个分片...`);

                const formData = new FormData();
                formData.append('file', chunk);

                const uploadRes = await fetch(`${BASE_URL}/files/multipart/upload?uploadId=${uploadId}&partNumber=${partNumber}`, {
                    method: 'POST',
                    body: formData
                }).then(async res => {
                    if (!res.ok) {
                        const text = await res.text();
                        throw new Error(`HTTP ${res.status}: ${text.substring(0, 100)}`);
                    }
                    return res.json();
                });

                if (uploadRes.code !== 200) throw new Error(`分片 ${partNumber} 上传失败: ${uploadRes.msg}`);

                const etag = uploadRes.data;
                log(`分片 ${partNumber} 上传成功, etag: ${etag}`);

                parts.push({partNumber, etag});

                // 更新进度条
                const percent = Math.round(((i + 1) / chunks) * 100);
                progressBar.style.width = percent + '%';
            }

            // 4. 完成分片上传
            log('所有分片上传完成，正在合并...');
            const completeRes = await fetch(`${BASE_URL}/files/multipart/complete`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    fileName: file.name,
                    uploadId: uploadId,
                    md5: md5,
                    parts: parts
                })
            }).then(async res => {
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`HTTP ${res.status}: ${text.substring(0, 100)}`);
                }
                return res.json();
            });

            if (completeRes.code !== 200) throw new Error(completeRes.msg || '合并失败');

            log('文件上传并合并成功！');
            showStatus('上传成功！', 'success');
        } catch (error) {
            console.error(error);
            log(`错误: ${error.message}`);
            showStatus(`上传失败: ${error.message}`, 'error');
        } finally {
            uploadBtn.disabled = false;
        }
    };
</script>

</body>
</html>
