# ZSK-Cloud 企业级微服务脚手架

## 项目版本信息

**项目版本**: 1.0.0-SNAPSHOT  
**项目描述**: 企业级微服务脚手架 - 基于JDK21/SpringBoot3/SCA2025/Nacos3.1.1  
**GitHub地址**: https://github.com/zsk-cloud/zsk-cloud

### 核心技术栈版本

| 技术组件 | 版本 | 说明 |
|---------|------|------|
| JDK | 21 | Java开发环境 |
| Spring Boot | 3.5.0 | 核心框架 |
| Spring Cloud | 2025.0.0 | 微服务治理 |
| Spring Cloud Alibaba | 2025.0.0.0 | 阿里巴巴微服务组件 |
| Nacos | 3.1.1 | 服务注册与配置中心 |

### 核心依赖版本

#### 数据库相关
| 组件 | 版本 | 用途 |
|------|------|------|
| MySQL Connector/J | 8.3.0 | MySQL数据库驱动 |
| Druid | 1.2.23 | 数据库连接池 |
| MyBatis-Plus | 3.5.7 | ORM框架 |
| MongoDB | 5.2.0 | 文档数据库 |

#### 缓存相关
| 组件 | 版本 | 用途 |
|------|------|------|
| Redis | 3.4.1 | 缓存数据库 |
| Lettuce | 6.3.2.RELEASE | Redis客户端 |
| Redisson | 3.27.0 | Redis分布式客户端 |
| Caffeine | 3.1.8 | 本地缓存框架 |

#### 消息队列
| 组件 | 版本 | 用途 |
|------|------|------|
| RocketMQ | 5.2.0 | 分布式消息队列 |

#### 微服务治理
| 组件 | 版本 | 用途 |
|------|------|------|
| Nacos | 3.1.1 | 服务注册与配置中心 |
| Sentinel | 2025.0.0.0 | 流量控制与熔断降级 |

#### 分布式调度
| 组件 | 版本 | 用途 |
|------|------|------|
| XXL-JOB | 2.4.1 | 分布式任务调度平台 |

#### 存储服务
| 组件 | 版本 | 用途 |
|------|------|------|
| MinIO | 8.5.8 | 对象存储服务 |
| 阿里云OSS | 3.18.1 | 云对象存储 |
| EasyExcel | 4.0.3 | Excel操作工具 |

#### 搜索引擎
| 组件 | 版本 | 用途 |
|------|------|------|
| Elasticsearch | 8.12.0 | 分布式搜索引擎 |

#### 工具类库
| 组件 | 版本 | 用途 |
|------|------|------|
| Hutool | 5.8.40 | Java工具类库 |
| Guava | 33.0.0-jre | Google工具类库 |
| Apache Commons IO | 2.18.0 | IO工具类 |
| Apache Commons Collections4 | 4.4 | 集合工具类 |
| Jackson | 2.17.0 | JSON序列化框架 |
| MapStruct | 1.5.5.Final | 对象映射工具 |
| Lombok | 1.18.36 | Java代码简化工具 |
| Kryo | 5.6.0 | 高性能序列化框架 |
| TTL | 2.14.5 | 线程上下文传递 |

#### 安全认证
| 组件 | 版本 | 用途 |
|------|------|------|
| JJWT | 0.12.5 | JWT令牌处理 |
| Bouncy Castle | 1.78 | 加密算法支持 |

#### API文档
| 组件 | 版本 | 用途 |
|------|------|------|
| Knife4j | 4.5.0 | Swagger增强UI |
| SpringDoc | 2.5.0 | OpenAPI 3文档生成 |

#### 监控运维
| 组件 | 版本 | 用途 |
|------|------|------|
| Micrometer | 1.13.0 | 应用监控指标 |
| Prometheus | 1.13.0 | 监控数据收集 |
| SkyWalking | 9.1.0 | APM应用性能监控 |

### 模块依赖关系

```
zsk-cloud (根模块)
├── zsk-common (通用模块)
│   ├── zsk-common-core          # 基础核心模块
│   ├── zsk-common-datasource    # 数据源模块
│   ├── zsk-common-redis         # Redis缓存模块
│   ├── zsk-common-security      # 安全认证模块
│   ├── zsk-common-log           # 日志模块
│   ├── zsk-common-swagger       # API文档模块
│   ├── zsk-common-datascope     # 数据权限模块
│   ├── zsk-common-sentinel      # 限流熔断模块
│   ├── zsk-common-xxljob        # 任务调度模块
│   ├── zsk-common-oss           # 对象存储模块
│   └── zsk-common-mongodb       # MongoDB模块
├── zsk-api (接口定义模块)
│   └── zsk-api-system           # 系统服务接口
├── zsk-auth                     # 认证授权服务
├── zsk-gateway                  # 网关服务
├── zsk-module (业务模块)
│   └── zsk-module-system        # 系统管理模块
└── zsk-visual (可视化模块)
    └── zsk-visual-monitor       # 监控中心模块
```

### 内部模块功能说明

| 模块名称 | 功能描述 | 主要组件 |
|----------|----------|----------|
| zsk-common-core | 基础核心功能 | 统一响应、异常处理、工具类、常量、枚举 |
| zsk-common-datasource | 数据源管理 | 多数据源配置、数据源切换、数据权限 |
| zsk-common-redis | 缓存管理 | RedisTemplate、缓存注解、分布式锁 |
| zsk-common-security | 安全认证 | JWT、OAuth2、权限校验、安全配置 |
| zsk-common-log | 日志管理 | 操作日志、访问日志、日志收集 |
| zsk-common-swagger | API文档 | Knife4j、OpenAPI3文档生成 |
| zsk-common-datascope | 数据权限 | 数据范围控制、行级权限过滤 |
| zsk-common-sentinel | 流量治理 | 限流、熔断、降级、热点参数 |
| zsk-common-xxljob | 任务调度 | 分布式定时任务、任务管理 |
| zsk-common-oss | 对象存储 | MinIO、阿里云OSS文件上传下载 |
| zsk-common-mongodb | 文档数据库 | MongoDB操作、文档存储 |
| zsk-api-system | 系统接口 | 系统服务Feign接口定义 |
| zsk-auth | 认证中心 | 用户认证、令牌管理、权限验证 |
| zsk-gateway | 网关服务 | 路由转发、负载均衡、安全过滤 |
| zsk-module-system | 系统管理 | 用户、角色、菜单、部门等管理 |
| zsk-visual-monitor | 监控中心 | 系统监控、健康检查、指标展示 |

zsk-common-datasource


### 业务模块

#### zsk-system（系统管理）
| 功能     | 表名         | 说明           |
| -------- | ------------ | -------------- |
| 用户管理 | `sys_user`   | 多租户用户隔离 |
| 角色管理 | `sys_role`   | 数据权限绑定   |
| 用户和角色关联 | sys_user_role | 用户和角色id关联 |
| 菜单管理 | `sys_menu`   | 动态路由生成   |
| 角色和菜单关联 | sys_role_menu | 角色和菜单id关联 |
| 字典管理 | `sys_dict`   | 系统级枚举     |
| 参数管理 | `sys_config` | 运行时配置     |
| 通知公告 | `sys_notice` | 富文本编辑     |

都继承BaseEntity

对应的sql写到sql/myslq


### 网关服务 (zsk-gateway)

**核心功能：**

| 功能     | 实现技术                  | 配置位置          |
| -------- | ------------------------- | ----------------- |
| 路由转发 | Spring Cloud Gateway      | `application.yml` |
| 负载均衡 | Spring Cloud LoadBalancer | 默认轮询          |
| 限流熔断 | Sentinel                  | 网关流控规则      |
| 认证鉴权 | 全局过滤器                | `AuthFilter`      |
| 日志追踪 | Sleuth + Micrometer       | TraceID传递       |
| 跨域处理 | `CorsWebFilter`           | 全局配置          |

### 请求处理链路全景 (过滤器链)

#### 1. 链路执行顺序图

```text
客户端请求 
   │
[ 网关层 (zsk-gateway) ]
   │  1. XssFilter (请求清洗)
   │  2. Whitelist Check (白名单放行)
   │  3. AuthFilter (按需校验：存在Token则校验并续期；无Token则视为匿名访问)
   │  4. Header Injection (用户信息透传)
   │  5. Sentinel (限流降级)
   │  6. LoadBalancer (负载均衡转发)
   ↓
[ 业务层 (微服务) ] ── 由 SecurityConfiguration 统一配置
   │  7. RepeatSubmitFilter (防重提交校验)
   │  8. HeaderContextFilter (Header转ThreadLocal上下文)
   │  9. Method Security Check (基于注解的权限判定，如 @PreAuthorize)
   │      │
   │      ├─ 判定失败 -> 返回 403 Forbidden (未登录或无权限)
   │      └─ 判定通过 -> 进入 Controller
   ↓
[ 业务处理 ]
      10. 执行业务代码 (通过 SecurityUtils 获取用户信息)
```

#### 2. 链路详细描述
##### 1. 网关层处理 (zsk-gateway)
网关作为统一入口，负责全局的安全与流量控制：
- **XSS 过滤 (XssFilter)**：清洗请求参数（Query/Body）中的恶意 HTML 标签与脚本，防止 XSS 攻击。
- **白名单校验**：检查请求路径是否匹配 `security.ignore.whites`。匹配则跳过后续所有鉴权逻辑。
- **认证拦截 (AuthFilter)**：
    - **匿名兼容**：如果请求未携带 Token，网关直接放行。下游服务将根据方法上的注解决定是否拦截。
    - **Token 校验**：如果携带了 Token，则校验其在 Redis 中的有效性。
    - **Token 续期**：校验成功后，自动延长 Redis 中 Token 的有效期（实现滑动过期）。
    - **异常拦截**：若携带了 Token 但校验失败（过期或伪造），网关将直接返回 401 响应。
- **用户信息透传**：将解析出的用户 ID、用户名、权限等信息封装进自定义请求头（如 `X-User-Id`），向下游微服务透传。
- **流量治理 (Sentinel)**：根据预设规则进行限流、熔断与降级保护。

##### 2. 业务层处理 (zsk-common-security)
业务层的安全逻辑实现了**细粒度权限控制**：
- **防重提交 (RepeatSubmitFilter)**：拦截短时间内完全相同的请求，防止表单重复提交。
- **上下文恢复 (HeaderContextFilter)**：
    - 读取网关透传的用户信息并存入 `SecurityContext` (ThreadLocal)。
- **安全配置 (SecurityConfiguration)**：
    - **全局放行**：默认 `anyRequest().permitAll()`，允许匿名流量进入 Controller 层。
    - **注解驱动鉴权**：启用 `@EnableMethodSecurity`。仅在 Controller 方法上标注了 `@PreAuthorize` 等注解时，Spring Security 才会执行拦截逻辑。
    - 在 Controller 方法上直接使用 @PreAuthorize("hasAuthority('system:user:list')") 或 @PreAuthorize("hasRole('admin')") 进行鉴权。
- **异常响应**：
    - **401 (Unauthorized)**：当访问受保护资源且未登录时，由网关或 Security 抛出。
    - **403 (Forbidden)**：已登录但无权限访问特定资源时，返回 JSON 响应。

---

## 环境配置
### 配置文件分层

| 配置文件               | 生效环境 | 说明          |
| ---------------------- | -------- | ------------- |
| `application.yml`      | 所有环境 | 公共配置      |
| `application-dev.yml`  | 开发环境 | 本地调试      |
| `application-prod.yml` | 生产环境 | 线上部署      |
| `bootstrap.yml`        | 启动时   | Nacos配置中心 |

### 端口规划

| 服务        | 端口  | 说明       |
| ----------- | ----- | ---------- |
| zsk-gateway | 8080  | 统一入口   |
| zsk-auth    | 10010 | 认证中心   |
| zsk-system  | 20010 | 系统服务   |
| zsk-gen     | 20020 | 代码生成   |
| zsk-job     | 20030 | 定时任务   |
| zsk-file    | 20040 | 文件服务   |
| zsk-bpm     | 20050 | 工作流服务 |
| zsk-monitor | 20060 | 监控中心   |

---

## 部署架构
```
                    ┌─────────────┐
                    │   Nginx     │  ← 负载均衡/SSL终结
                    │   (80/443)  │
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │   Gateway   │  ← 网关集群（8080）
                    │   (集群)     │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐       ┌────▼────┐       ┌────▼────┐
   │  Auth   │       │ System  │       │  File   │  ← 业务服务集群
   │ (10010) │       │ (20010) │       │ (20040) │
   └────┬────┘       └────┬────┘       └────┬────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
              ┌────────────┼────────────┐
              │            │            │
         ┌────▼────┐  ┌────▼────┐  ┌────▼────┐
         │  Nacos  │  │  Redis  │  │  MySQL  │  ← 基础设施
         │ (8848)  │  │ (6379)  │  │ (3306)  │
         └─────────┘  └─────────┘  └─────────┘
```

---

## 环境搭建

mysql
地址：192.168.101.129:3306
账号：mysql_Ck2bRf
密码：mysql_Ck2bRf

redis
地址：192.168.101.129:6379
账号：redis_XfFtnT
密码：redis_XfFtnT

minio
地址：192.168.101.129:9000
账号：minio_RW8nGM
密码：minio_fZEpaA

nacos
地址：192.168.101.129:8848
账号：nacos
密码：123456
Nacos身份验证密钥值：security
Nacos身份验证令牌：SecretKey012345678901234567890123456789012345678901234567890123456789

Sentinel
地址：192.168.101.129:8719
账号：sentinel
密码：sentinel